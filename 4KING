-- โหลดรายชื่อผู้ใช้ที่อนุญาตจาก URL --
local allowedUsersUrl = "https://raw.githubusercontent.com/dyumra/Whitelist/refs/heads/main/4KING-PREMIUM"

local allowedUsers = {}

local success, result = pcall(function()
    local code = game:HttpGet(allowedUsersUrl)
    local func = loadstring(code)
    if func then
        return func()
    else
        error("ไม่สามารถโหลดฟังก์ชันจากโค้ดได้")
    end
end)

if success and type(result) == "table" then
    allowedUsers = result
    print("[System] โหลดรายชื่อผู้ใช้งานสำเร็จ")
else
    warn("[System] โหลดรายชื่อผู้ใช้งานล้มเหลว: ", result)
    allowedUsers = {}
end

-- ตรวจสอบสิทธิ์ LocalPlayer --
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

if not allowedUsers[LocalPlayer.Name] then
    local kickMessage = "[Warning] โปรดซื้อสคริปก่อนใช้งาน ราคา 150 บาท\n[Access Denied] คุณไม่มีสิทธิ์ใช้สคริปต์นี้: " .. LocalPlayer.Name
    warn(kickMessage)
    LocalPlayer:Kick(kickMessage)
    return
end

-- Services --
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Remote Events --
local GiveItemAllEvent = ReplicatedStorage:WaitForChild("GiveItemAll")
local ReviveEvent = ReplicatedStorage:WaitForChild("ReviveSystem"):WaitForChild("Event")

-- Variables --
local autoRespawn = false
local itemName = ""
local itemAmount = 0

local hitboxEnabled = false
local headSize = 1

-- Event connection management for cleanup --
local characterAddedConnections = {}

-- Load WindUI --
local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()
assert(WindUI, "[Error] Failed to load WindUI")

-- Confirmation Popup before showing UI --
local Confirmed = false
WindUI:Popup({
    Title = "4KING HIGHCLASS",
    Icon = "user",
    IconThemed = true,
    Content = "Script By YJSCRIPT",
    Buttons = {
        { Title = "Cancel", Variant = "Secondary", Callback = function() end },
        { Title = "Continue", Icon = "arrow-right", Variant = "Primary", Callback = function() Confirmed = true end }
    }
})
repeat task.wait() until Confirmed

-- Create Main Window --
local Window = WindUI:CreateWindow({
    Title = "4KING HIGHCLASS",
    IconThemed = true,
    Icon = "user",
    Author = "By YJSCRIPT",
    Size = UDim2.fromOffset(500, 300),
    Transparent = true,
    Theme = "Dark",
})

Window:EditOpenButton({
    Title = "OPEN YJSCRIPT",
    Icon = "monitor",
    CornerRadius = UDim.new(0, 6),
    StrokeThickness = 2,
    Color = ColorSequence.new(Color3.fromRGB(30, 30, 30), Color3.fromRGB(255, 255, 255)),
    Draggable = true,
})

-- Tabs --
local MainTab = Window:Tab({ Title = "Main", Icon = "rocket" })
local FeatureTab = Window:Tab({ Title = "Feature", Icon = "star" })
local HitboxTab = Window:Tab({ Title = "Hitbox", Icon = "sword" })

-- Utility Functions --

-- Function to give item via RemoteEvent --
local function GiveItem(name, amount)
    if typeof(name) == "string" and typeof(amount) == "number" and amount > 0 then
        GiveItemAllEvent:FireServer(name, amount)
        print(("[GiveAll] เสกของเรียบร้อย: %d x %s"):format(amount, name))
    else
        warn("[GiveAll] ข้อมูลไม่ถูกต้อง! กรุณากรอกชื่อและจำนวนให้ถูกต้อง")
    end
end

-- Resize all heads except local player --
local function ResizeHeads()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local char = player.Character
            if char and char:FindFirstChild("Head") then
                char.Head.Size = Vector3.new(headSize, headSize, headSize)
                local mesh = char.Head:FindFirstChildOfClass("SpecialMesh")
                if mesh then
                    mesh.Scale = Vector3.new(1, 1, 1) * headSize
                end
            end
        end
    end
end

-- Reset heads to default size --
local function ResetHeads()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local char = player.Character
            if char and char:FindFirstChild("Head") then
                char.Head.Size = Vector3.new(2, 1, 1) -- Default Roblox head size
                local mesh = char.Head:FindFirstChildOfClass("SpecialMesh")
                if mesh then
                    mesh.Scale = Vector3.new(1, 1, 1)
                end
            end
        end
    end
end

-- Disconnect all event connections to avoid duplicates --
local function DisconnectAllConnections()
    for _, conn in pairs(characterAddedConnections) do
        conn:Disconnect()
    end
    characterAddedConnections = {}
end

-- Connect CharacterAdded events for all players and new players --
local function ConnectCharacterAddedEvents()
    -- Existing players
    for _, player in pairs(Players:GetPlayers()) do
        local conn = player.CharacterAdded:Connect(function(char)
            if hitboxEnabled and player ~= LocalPlayer then
                local head = char:WaitForChild("Head")
                head.Size = Vector3.new(headSize, headSize, headSize)
                local mesh = head:FindFirstChildOfClass("SpecialMesh")
                if mesh then
                    mesh.Scale = Vector3.new(1, 1, 1) * headSize
                end
            end
        end)
        table.insert(characterAddedConnections, conn)
    end

    -- New players
    local playerAddedConn
    playerAddedConn = Players.PlayerAdded:Connect(function(player)
        local conn = player.CharacterAdded:Connect(function(char)
            if hitboxEnabled and player ~= LocalPlayer then
                local head = char:WaitForChild("Head")
                head.Size = Vector3.new(headSize, headSize, headSize)
                local mesh = head:FindFirstChildOfClass("SpecialMesh")
                if mesh then
                    mesh.Scale = Vector3.new(1, 1, 1) * headSize
                end
            end
        end)
        table.insert(characterAddedConnections, conn)
    end)
    table.insert(characterAddedConnections, playerAddedConn)
end

-- UI Setup --

-- Main Tab Inputs --
MainTab:Input({
    Title = "ชื่อของ",
    Placeholder = "ชื่อของที่ต้องการ",
    Callback = function(text)
        itemName = text
    end,
})

MainTab:Input({
    Title = "จำนวน",
    Placeholder = "จำนวนที่ต้องการ",
    Callback = function(text)
        itemAmount = tonumber(text) or 0
    end,
})

MainTab:Button({
    Title = "เริ่มเสก",
    Icon = "gift",
    Callback = function()
        if itemName ~= "" and itemAmount > 0 then
            GiveItem(itemName, itemAmount)
        else
            warn("[GiveAll] กรุณากรอกชื่อของและจำนวนให้ถูกต้องก่อนเสก")
        end
    end,
})

-- Feature Tab Toggles and Buttons --

FeatureTab:Toggle({
    Title = "เกิดเอง อัตโนมัติ",
    Default = false,
    Callback = function(state)
        autoRespawn = state
        if autoRespawn then
            spawn(function()
                while autoRespawn do
                    ReviveEvent:FireServer("Respawn", LocalPlayer)
                    wait(3)
                end
            end)
            print("[AutoRespawn] เปิดใช้งานเกิดเองอัตโนมัติ")
        else
            print("[AutoRespawn] ปิดใช้งานเกิดเองอัตโนมัติ")
        end
    end,
})

FeatureTab:Button({
    Title = "เกิดเอง",
    Icon = "gift",
    Callback = function()
        ReviveEvent:FireServer("Respawn", LocalPlayer)
        print("[Respawn] เรียกเกิดใหม่สำเร็จ")
    end,
})

-- Hitbox Tab Controls --

HitboxTab:Slider({
    Title = "ปรับขนาดหัว",
    Value = { Min = 1, Max = 50, Default = 1 },
    Callback = function(value)
        headSize = value
        if hitboxEnabled then
            ResizeHeads()
            print(("[Hitbox] ปรับขนาดหัวเป็น: %d"):format(headSize))
        end
    end,
})

HitboxTab:Toggle({
    Title = "เริ่มปรับขนาด",
    Icon = "package",
    Default = false,
    Callback = function(state)
        hitboxEnabled = state
        if hitboxEnabled then
            ResizeHeads()
            ConnectCharacterAddedEvents()
            print("[Hitbox] เปิดการปรับขนาดหัว")
        else
            ResetHeads()
            DisconnectAllConnections()
            print("[Hitbox] ปิดการปรับขนาดหัวและรีเซ็ตขนาด")
        end
    end,
})

local args = {
    [1] = "Use",
    [2] = "Armor",
    [3] = 1
}

game:GetService("ReplicatedStorage"):WaitForChild("Inventory_Remotes"):WaitForChild("Event"):FireServer(unpack(args))

local args = {
    [1] = "Use",
    [2] = "MedicineV",
    [3] = 1
}

game:GetService("ReplicatedStorage"):WaitForChild("Inventory_Remotes"):WaitForChild("Event"):FireServer(unpack(args))


local args = {
    [1] = "Use",
    [2] = "Clothes",
    [3] = 1
}

game:GetService("ReplicatedStorage"):WaitForChild("Inventory_Remotes"):WaitForChild("Event"):FireServer(unpack(args))

local args = {
    [1] = "Fire",
    [2] = Vector3.new(4459.00341796875, -26.564987182617188, 4093.643798828125),
    [3] = workspace:WaitForChild("Garage"):WaitForChild("Part")
}

game:GetService("ReplicatedStorage"):WaitForChild("DeagleFunction"):InvokeServer(unpack(args))


-- Script Ready Message --
print("[Script] 4KING HIGHCLASS Script โหลดเรียบร้อยแล้ว")
